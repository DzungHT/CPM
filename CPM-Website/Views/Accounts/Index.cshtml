
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="row" id="UserApp" ng-controller="UserController">
    <div id=formIndex>
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="title_left">
                <h3>Quản lý người dùng</h3>
            </div>
            <div class="title_right">
                <button type="button" class="btn btn-success btn-add" onclick="goInsert()">
                    <span class="glyphicons glyphicons-plus-sign"></span>
                    Thêm mới
                </button>
            </div>
            <div class="clearfix"></div>
        </div>

        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Điều kiện tìm kiếm</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <br />
                    <form id="searchForm" class="form-horizontal form-label-left">
                        @Html.AntiForgeryToken()
                        <div class="form-group no-padding">
                            <label class="control-label col-sm-2">
                                Tên đăng nhập
                            </label>
                            <div class="col-sm-4">
                                <input ng-model="dataSearch.LoginName" id="LoginName" name="LoginName" type="text" class="form-control validate[optional,maxSize[255]]" placeholder="Tên đăng nhập">
                            </div>
                            <label class="control-label col-sm-2">
                                Tên đầy đủ
                            </label>
                            <div class="col-sm-4">
                                <input ng-model="dataSearch.FullName" id="FullName" name="FullName" type="text" class="form-control validate[optional,maxSize[255]]" placeholder="Tên đầy đủ">
                            </div>
                        </div>
                        <div class="form-group no-padding">
                            <label class="control-label col-sm-2">
                                Số điện thoại
                            </label>
                            <div class="col-sm-4">
                                <input ng-model="dataSearch.PhoneNumber" id="PhoneNumber" name="PhoneNumber" type="text" class="form-control validate[optional,maxSize[255]]" placeholder="Số điện thoại">
                            </div>
                            <label class="control-label col-sm-2">
                                Email
                            </label>
                            <div class="col-sm-4">
                                <input ng-model="dataSearch.Email" id="Email" name="Email" type="text" class="form-control validate[optional,maxSize[255],custom[email]]" placeholder="Email">
                            </div>
                        </div>
                        <div class="form-group no-padding">
                            <label class="control-label col-sm-2">
                                Trạng thái
                            </label>
                            <div class="col-sm-4">
                                <select class="form-control"ng-model="dataSave.Status" id="Status">
                                    <option>--Chọn tất cả--</option>
                                    <option value="1">Hoạt động</option>
                                    <option value="0">Khóa</option>
                                </select>
                            </div>
                            <label class="control-label col-sm-2">
                            </label>
                            <div class="col-sm-4">
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="text-right" style="padding-right: 5px;">
                                <button type="button" class="btn btn-default" onclick="search()">
                                    <span class="glyphicons glyphicons-search green"></span>
                                    Tìm kiếm
                                </button>
                                <button type="button" class="btn btn-default" onclick="onResetForm()">
                                    <span class="glyphicons glyphicons-remove red"></span>
                                    Xóa bộ lọc
                                </button>
                            </div>
                         </div>                    
               </form>
                </div>
            </div>
        </div>

        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>Kết quả tìm kiếm</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content table-responsive">
                    <table id="searchResult" class="table table-bordered table-striped table-hover">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên đăng nhập</th>
                                <th>Tên đầy đủ</th>
                                <th>Email</th>
                                <th>Số điện thoại</th>
                                <th>Trạng thái</th>
                                <th>Tác động</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id=formSave style="display:none">
        @RenderPage("Form.cshtml");
    </div>
</div>
<div id="flagSaveResult" style="display:none"></div>

@section script{   
    <script>
        var ctrl = app.controller('UserController', ['$scope', function ($scope) {
            $scope.dataSearch = {};
            $scope.dataSave = {};
            $scope.dataTable = $("#searchResult").DataTable({
                order: [[2, "asc"]],
                ajax: {
                    url: '/Accounts/searchProcess',
                    type: 'POST',
                    data: function (d) {
                        $scope.dataSearch.DataTable = d;
                        return $scope.dataSearch;
                    }
                },
                columns: [
                    {
                        searchable: false,
                        orderable: false,
                        data: null,
                        className: "text-center",
                        render: function (data, type, row, cell) {
                            var info = $scope.dataTable.page.info();
                            var stt = 1 + (info.page * info.length) + cell.row;
                            return stt;
                        }
                    },
                    { data: 'LoginName', },
                    { data: 'FullName' },
                    { data: 'Email' },
                    { data: 'PhoneNumber' },
                    {
                        searchable: false,
                        orderable: false,
                        data: null,
                        className: "text-center",
                        render: function (data, type, row, cell) {
                            return data.Status == 1 ? 'Hoạt động' : 'Khóa';
                        }
                    },
                    {
                        searchable: false,
                        orderable: false,
                        data: null,
                        className: "text-center",
                        render: function (data, type, row, cell) {
                            return '<a href="javascript:;" onclick="goEdit(' + data.MenuID + ')" class="text-success" style="margin-right: 7px">'
                                   + '<i class="fa fa-edit fa-2x" title="Sửa"></i>'
                                   +'</a>'
                                   + '<a href="javascript:;" onclick= "restartPassword(' + data.MenuID + ')" class="red">'
                                   + '<i class="fa fa-refresh fa-2x" title="Restart"></i>'
                                   + '</a>'
                                    + '<a href="javascript:;" onclick= "lockUnlock(' + data.MenuID + ')" class="' + data.Status == 1 ? 'green' : 'orange' + '">'
                                    + '<i class="fa ' + data.Status == 1 ? 'fa-unlock' : 'fa-lock' + ' fa-2x" title="Restart"></i>'
                                    + '</a>';
                            ;
                        }
                    },
                ]
            });
        }]);
        $(document).ready(function () {
            var scope = angular.element($('#UserApp')).scope();
            $.get('/masterData/getListApplication', function (data) {
                scope.listApplication = data;
                scope.$apply();
            });

            $.get('/masterData/GetListMenu', function (data) {
                scope.listMenu = data;
                scope.$apply();
            });
        });
        function search() {
            var scope = angular.element($('#UserApp')).scope();
            if ($('#searchForm').validationEngine("validate")) {
                scope.dataTable.ajax.reload();
            }
        }
        function onResetForm(e) {
            var scope = angular.element($('#UserApp')).scope();
            if (e === 'save') {
                scope.dataSave.UserID = "";
                scope.dataSave.LoginName = "";
                scope.dataSave.FullName = "";
                scope.dataSave.PhoneNumber = "";
                scope.dataSave.Email = "";
                scope.dataSave.Password = "";
            } else {
                scope.dataSearch.LoginName = "";
                scope.dataSearch.FullName = "";
                scope.dataSearch.PhoneNumber = "";
                scope.dataSearch.Email = "";
                scope.dataSearch.Status = "";
            }
            scope.$apply();
        }
        function restartPassword(id) {
            tctConfirm(function () {
                var url = '/Accounts/RestartPassword';
                var formData = getFormAsJson('searchForm');
                var flag = 'flagSaveResult';
                formData.id = id;
                tctDeferredAjax(flag, url, formData).fail(function () {
                    alert('Hết phiên làm việc!');
                    tctResetProgress();
                }).done(function () {
                    search();
                });
            }, 'Bạn muốn xóa bản ghi này ?');
        }
        function lockUnlock(id) {
            tctConfirm(function () {
                var url = '/Accounts/LockUnlock';
                var formData = getFormAsJson('searchForm');
                var flag = 'flagSaveResult';
                formData.id = id;
                tctDeferredAjax(flag, url, formData).fail(function () {
                    alert('Hết phiên làm việc!');
                    tctResetProgress();
                }).done(function () {
                    search();
                });
            }, 'Bạn muốn xóa bản ghi này ?');
        }
        function goEdit(id) {
            var url = "/Accounts/prepareUpdate?id=" + id;
            var data = '';
            tctDeferredAjaxGet(url, data).done(function (data) {
                var scope = angular.element($('#UserApp')).scope();
                scope.dataSave.UserID = data.UserID;
                scope.dataSave.LoginName = data.LoginName;
                scope.dataSave.FullName = data.FullName;
                scope.dataSave.PhoneNumber = data.PhoneNumber;
                scope.dataSave.Email = data.Email;
                scope.dataSave.Password = data.Password;
                scope.$apply();
                goInsert(true);
            }).fail(function () {
                alert('Có lỗi xảy ra!');
                tctResetProgress();
            });
        }
        function goInsert(e) {
            tctToggleFieldset($('#formIndex'));
            if (!e) {
                onResetForm('save');
            }
            tctToggleFieldset($('#formSave'));
        }
        function goSearch() {
            tctToggleFieldset($('#formIndex'));
            tctToggleFieldset($('#formSave'));
            search();
        }
        function actionSave() {
            if ($('#saveForm').validationEngine("validate")) {
                tctConfirm(function () {
                    var url = '/menus/save';
                    var formData = getFormAsJson('saveForm');
                    var flag = 'flagSaveResult';
                    var scope = angular.element($('#UserApp')).scope();
                    formData.UserID = scope.dataSave.UserID;
                    tctDeferredAjax(flag, url, formData).fail(function () {
                        alert('Có lỗi xảy ra!');
                        tctResetProgress();
                    }).done(function () {
                        goSearch();
                    });
                }, 'Bạn có muốn thực hiện ?');
            }
        }
    </script>
}
